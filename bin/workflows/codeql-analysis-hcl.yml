name: Scan Terraform using tfsec

on:
  push:
    branches: ["main", "master"]
  pull_request:
    branches: ["main", "master"]
  workflow_dispatch:
  schedule:
    - cron: "27 4 * * 5"

jobs:
  run-scan:
    name: Run Terraform Scan
    runs-on: [self-hosted, ubuntu-20.04]

    permissions:
      contents: read
      pull-requests: write

    steps:
    - name: Checkout Repo
      uses: actions/checkout@v2

    # https://github.com/aquasecurity/tfsec-pr-commenter-action
    - name: Comment on PR with Scan Results
      if: github.event_name == 'pull_request'
      uses: aquasecurity/tfsec-pr-commenter-action@v1.3.1
      with:
        github_token: ${{ secrets.GITHUB_TOKEN }}
        soft_fail_commenter: true

    # https://github.com/aquasecurity/tfsec-sarif-action
    - name: Scan Terraform with tfsec
      uses: aquasecurity/tfsec-sarif-action@v0.1.4
      with:
        sarif_file: tfsec.sarif

    - name: Upload tfsec SARIF results
      uses: github/codeql-action/upload-sarif@v2
      with:
        sarif_file: tfsec.sarif
